<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîê Ferramenta de Reset de Senhas - Firebase RTDB</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-width: 900px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
        }

        .alert h3 {
            font-size: 16px;
            margin-bottom: 10px;
        }

        .alert ul {
            list-style: none;
            padding-left: 0;
        }

        .alert li {
            padding: 5px 0;
            font-family: monospace;
            font-size: 14px;
        }

        .config-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .config-section h2 {
            color: #555;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .status-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            border-left: 4px solid #6c757d;
        }

        .status-card.connected {
            border-left-color: #28a745;
        }

        .status-card.error {
            border-left-color: #dc3545;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .status-label {
            font-weight: 600;
            color: #555;
        }

        .status-value {
            font-family: monospace;
            color: #333;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 25px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .log-section {
            margin-top: 30px;
        }

        .log-section h2 {
            color: #555;
            font-size: 18px;
            margin-bottom: 15px;
        }

        #log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }

        .log-success {
            color: #4ade80;
        }

        .log-error {
            color: #f87171;
        }

        .log-info {
            color: #60a5fa;
        }

        .log-warning {
            color: #fbbf24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Ferramenta de Reset de Senhas</h1>
        <p class="subtitle">Resetar senhas de usu√°rios no Firebase Realtime Database</p>

        <div class="alert alert-warning">
            <h3>üìã Senhas Padr√£o (SHA-256 com salt)</h3>
            <ul>
                <li><strong>admin:</strong> admin123 ‚Üí c08ab1a7671509ccb5ecdf9868eb30df793ce5104b404d11cfa82d4b84029283</li>
                <li><strong>gestor:</strong> gestor123 ‚Üí ca762c2ec7cdcc2fb79450121aba3642873df25ed035810c8f6a12b76f9f42fa</li>
                <li><strong>tecnico:</strong> tecnico123 ‚Üí e343cbd1e3d223ee96c21a2b18a61b10d35549cdecae770e36b2c598100f3c02</li>
            </ul>
        </div>

        <div class="config-section">
            <h2>‚öôÔ∏è Status da Conex√£o Firebase</h2>
            <div class="status-card" id="statusCard">
                <div class="status-row">
                    <span class="status-label">Firebase:</span>
                    <span class="badge badge-danger" id="firebaseStatus">Desconectado</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Database:</span>
                    <span class="status-value" id="databaseUrl">-</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Usu√°rios Encontrados:</span>
                    <span class="status-value" id="usersCount">-</span>
                </div>
            </div>
        </div>

        <div class="button-grid">
            <button class="btn-primary" onclick="connectFirebase()">
                üîå Conectar Firebase
            </button>
            <button class="btn-success" id="resetAdminBtn" onclick="resetUser('admin')" disabled>
                üë§ Resetar Admin
            </button>
            <button class="btn-success" id="resetGestorBtn" onclick="resetUser('gestor')" disabled>
                üëî Resetar Gestor
            </button>
            <button class="btn-success" id="resetTecnicoBtn" onclick="resetUser('tecnico')" disabled>
                üîß Resetar T√©cnico
            </button>
            <button class="btn-danger" id="resetAllBtn" onclick="resetAllUsers()" disabled>
                üîÑ Resetar Todos
            </button>
            <button class="btn-secondary" onclick="clearLog()">
                üóëÔ∏è Limpar Log
            </button>
        </div>

        <div class="log-section">
            <h2>üìä Log de Execu√ß√£o</h2>
            <div id="log"></div>
        </div>
    </div>

    <script type="module">
        // Import Firebase SDK v9 modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref, get, update, child } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

        let db = null;
        let app = null;
        let usersData = {};

        // Make functions available globally
        window.connectFirebase = connectFirebase;
        window.resetUser = resetUser;
        window.resetAllUsers = resetAllUsers;
        window.clearLog = clearLog;

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAkR0HSCj4rkT_NmvGLQEnDv2zNXiUaO7Q",
            authDomain: "solicitacoes-de-pecas.firebaseapp.com",
            databaseURL: "https://solicitacoes-de-pecas-default-rtdb.firebaseio.com",
            projectId: "solicitacoes-de-pecas",
            storageBucket: "solicitacoes-de-pecas.firebasestorage.app",
            messagingSenderId: "531360939",
            appId: "1:531360939:web:59f4e825a526463cc93d8f"
        };

        // SHA-256 hashing function - Canonical formula (matches utils.js implementation)
        // Formula: SHA256(password + 'diversey_salt_v1:' + username)
        async function hashSHA256(password, username) {
            const salt = 'diversey_salt_v1';
            const input = password + salt + ':' + username;
            const encoder = new TextEncoder();
            const data = encoder.encode(input);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // Default passwords mapping
        const defaultPasswords = {
            'admin': 'admin123',
            'gestor': 'gestor123',
            'tecnico': 'tecnico123'
        };

        // Role mapping
        const roleMapping = {
            'admin': 'administrador',
            'gestor': 'gestor',
            'tecnico': 'tecnico'
        };

        // Logging functions
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString('pt-BR');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('Log limpo', 'info');
        }

        function updateStatus(connected, usersCount = 0) {
            const statusCard = document.getElementById('statusCard');
            const firebaseStatus = document.getElementById('firebaseStatus');
            const databaseUrl = document.getElementById('databaseUrl');
            const usersCountEl = document.getElementById('usersCount');

            if (connected) {
                statusCard.classList.add('connected');
                firebaseStatus.className = 'badge badge-success';
                firebaseStatus.textContent = 'Conectado';
                databaseUrl.textContent = firebaseConfig.databaseURL;
                usersCountEl.textContent = usersCount;
                
                // Enable buttons
                document.getElementById('resetAdminBtn').disabled = false;
                document.getElementById('resetGestorBtn').disabled = false;
                document.getElementById('resetTecnicoBtn').disabled = false;
                document.getElementById('resetAllBtn').disabled = false;
            } else {
                statusCard.classList.remove('connected');
                statusCard.classList.add('error');
                firebaseStatus.className = 'badge badge-danger';
                firebaseStatus.textContent = 'Desconectado';
                
                // Disable buttons
                document.getElementById('resetAdminBtn').disabled = true;
                document.getElementById('resetGestorBtn').disabled = true;
                document.getElementById('resetTecnicoBtn').disabled = true;
                document.getElementById('resetAllBtn').disabled = true;
            }
        }

        // Connect to Firebase
        async function connectFirebase() {
            log('üöÄ Iniciando conex√£o com Firebase...', 'info');
            
            try {
                // Initialize Firebase
                app = initializeApp(firebaseConfig);
                db = getDatabase(app);
                
                log('‚úÖ Firebase inicializado com sucesso', 'success');
                log(`üìç Database URL: ${firebaseConfig.databaseURL}`, 'info');
                
                // Load users from Firebase RTDB
                log('üì• Carregando usu√°rios do Firebase RTDB...', 'info');
                const dbRef = ref(db);
                
                try {
                    const snapshot = await get(child(dbRef, 'data/diversey_users'));
                    
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        
                        // Check if it's the wrapper format with data property
                        if (data && data.data && Array.isArray(data.data)) {
                            usersData = data.data;
                            log(`‚úÖ ${usersData.length} usu√°rio(s) encontrado(s) no Firebase`, 'success');
                        } else if (Array.isArray(data)) {
                            usersData = data;
                            log(`‚úÖ ${usersData.length} usu√°rio(s) encontrado(s) no Firebase`, 'success');
                        } else {
                            log('‚ö†Ô∏è Formato de dados inesperado no Firebase', 'warning');
                            log(`Dados: ${JSON.stringify(data).substring(0, 200)}`, 'info');
                            usersData = [];
                        }
                        
                        // Log user information
                        if (Array.isArray(usersData) && usersData.length > 0) {
                            log('\nüìã Usu√°rios encontrados:', 'info');
                            usersData.forEach(user => {
                                log(`  - ${user.username} (role: ${user.role || 'N/A'}, id: ${user.id})`, 'info');
                            });
                        }
                        
                        updateStatus(true, usersData.length);
                    } else {
                        log('‚ö†Ô∏è Nenhum dado encontrado em data/diversey_users', 'warning');
                        log('üí° O caminho pode estar vazio ou n√£o existe ainda', 'info');
                        usersData = [];
                        updateStatus(true, 0);
                    }
                } catch (readError) {
                    log(`‚ùå Erro ao ler dados: ${readError.message}`, 'error');
                    log(`üí° C√≥digo do erro: ${readError.code || 'N/A'}`, 'warning');
                    throw readError;
                }
                
            } catch (error) {
                log(`‚ùå Erro ao conectar Firebase: ${error.message}`, 'error');
                if (error.code) {
                    log(`   C√≥digo do erro: ${error.code}`, 'error');
                }
                console.error('Erro completo:', error);
                updateStatus(false);
            }
        }

        // Reset a single user's password
        async function resetUser(username) {
            if (!db) {
                log('‚ùå Firebase n√£o conectado. Clique em "Conectar Firebase" primeiro.', 'error');
                return;
            }

            log(`\nüîÑ Iniciando reset de senha para: ${username}`, 'info');

            try {
                const password = defaultPasswords[username];
                if (!password) {
                    log(`‚ùå Senha padr√£o n√£o definida para: ${username}`, 'error');
                    return;
                }

                // Find user in loaded data
                const user = usersData.find(u => u.username === username);
                
                if (!user) {
                    log(`‚ö†Ô∏è Usu√°rio ${username} n√£o encontrado na base de dados`, 'warning');
                    log(`üí° Usu√°rios dispon√≠veis: ${usersData.map(u => u.username).join(', ')}`, 'info');
                    return;
                }

                log(`üìç Usu√°rio encontrado: ${user.username} (ID: ${user.id})`, 'info');

                // Generate password hash with username salt
                const passwordHash = await hashSHA256(password, username);
                log(`üîê Hash SHA-256 gerado para "${password}":`, 'info');
                log(`   ${passwordHash}`, 'info');

                // Update user in the array
                const userIndex = usersData.findIndex(u => u.id === user.id);
                if (userIndex !== -1) {
                    usersData[userIndex].passwordHash = passwordHash;
                    if (usersData[userIndex].password) {
                        delete usersData[userIndex].password;
                    }
                }

                // Save back to Firebase
                const dbRef = ref(db);
                const updates = {};
                updates['data/diversey_users'] = {
                    data: usersData,
                    updatedAt: Date.now(),
                    updatedBy: 'fix-passwords-tool'
                };

                await update(dbRef, updates);

                log(`‚úÖ Senha resetada com sucesso para: ${username}`, 'success');
                log(`   Nova senha: ${password}`, 'success');
                log(`   Hash salvo: ${passwordHash}`, 'info');
                
            } catch (error) {
                log(`‚ùå Erro ao resetar senha de ${username}: ${error.message}`, 'error');
                console.error('Erro completo:', error);
            }
        }

        // Reset all users' passwords
        async function resetAllUsers() {
            if (!db) {
                log('‚ùå Firebase n√£o conectado. Clique em "Conectar Firebase" primeiro.', 'error');
                return;
            }

            if (!confirm('Deseja realmente resetar a senha de TODOS os usu√°rios?')) {
                log('‚ùå Opera√ß√£o cancelada pelo usu√°rio', 'warning');
                return;
            }

            log('\nüîÑ Iniciando reset de senha de TODOS os usu√°rios...', 'info');
            log('='.repeat(60), 'info');

            let successCount = 0;
            let errorCount = 0;
            let skippedCount = 0;

            for (const user of usersData) {
                const username = user.username;
                log(`\nüîç Processando: ${username}`, 'info');

                const password = defaultPasswords[username];
                if (!password) {
                    log(`‚è≠Ô∏è Pulando ${username}: sem senha padr√£o definida`, 'warning');
                    skippedCount++;
                    continue;
                }

                try {
                    // Generate password hash
                    const passwordHash = await hashSHA256(password, username);
                    
                    // Update user in array
                    const userIndex = usersData.findIndex(u => u.id === user.id);
                    if (userIndex !== -1) {
                        usersData[userIndex].passwordHash = passwordHash;
                        if (usersData[userIndex].password) {
                            delete usersData[userIndex].password;
                        }
                    }

                    log(`‚úÖ Senha resetada: ${username} ‚Üí ${password}`, 'success');
                    log(`   Hash: ${passwordHash}`, 'info');
                    successCount++;
                } catch (error) {
                    log(`‚ùå Erro ao processar ${username}: ${error.message}`, 'error');
                    errorCount++;
                }
            }

            // Save all updates to Firebase
            if (successCount > 0) {
                try {
                    log('\nüíæ Salvando altera√ß√µes no Firebase...', 'info');
                    const dbRef = ref(db);
                    const updates = {};
                    updates['data/diversey_users'] = {
                        data: usersData,
                        updatedAt: Date.now(),
                        updatedBy: 'fix-passwords-tool'
                    };

                    await update(dbRef, updates);
                    log('‚úÖ Todas as altera√ß√µes salvas no Firebase com sucesso!', 'success');
                } catch (saveError) {
                    log(`‚ùå Erro ao salvar no Firebase: ${saveError.message}`, 'error');
                }
            }

            // Summary
            log('\n' + '='.repeat(60), 'info');
            log('üìä RESUMO DO RESET', 'info');
            log('='.repeat(60), 'info');
            log(`‚úÖ Sucesso: ${successCount}`, 'success');
            log(`‚ùå Erros: ${errorCount}`, 'error');
            log(`‚è≠Ô∏è Pulados: ${skippedCount}`, 'warning');
            log(`üìã Total processado: ${usersData.length}`, 'info');
            log('='.repeat(60), 'info');
        }

        // Initialize on load
        log('üîß Ferramenta de Reset de Senhas carregada e pronta', 'info');
        log('‚ö†Ô∏è Clique em "Conectar Firebase" para come√ßar', 'warning');
    </script>
</body>
</html>
