<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Diagn√≥stico de Autentica√ß√£o</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            color: #555;
            font-size: 20px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f093fb;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .status-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #6c757d;
        }

        .status-card.connected {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .status-card.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }

        .status-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .status-card .value {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(240, 147, 251, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .users-table-wrapper {
            overflow-x: auto;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .users-table th,
        .users-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .users-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
            position: sticky;
            top: 0;
        }

        .users-table tr:hover {
            background: #f8f9fa;
        }

        .users-table code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
            display: inline-block;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .test-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .test-form {
            display: grid;
            gap: 15px;
        }

        .form-group {
            display: grid;
            grid-template-columns: 150px 1fr;
            align-items: center;
            gap: 10px;
        }

        .form-group label {
            font-weight: 600;
            color: #555;
        }

        .form-group input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .test-result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            display: none;
        }

        .test-result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            display: block;
        }

        .test-result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            display: block;
        }

        .log-section {
            margin-top: 30px;
        }

        .log-section h2 {
            color: #555;
            font-size: 18px;
            margin-bottom: 15px;
        }

        #log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }

        .log-success {
            color: #4ade80;
        }

        .log-error {
            color: #f87171;
        }

        .log-info {
            color: #60a5fa;
        }

        .log-warning {
            color: #fbbf24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico de Autentica√ß√£o</h1>
        <p class="subtitle">Ferramenta de diagn√≥stico para verificar usu√°rios e testar autentica√ß√£o</p>

        <div class="section">
            <h2>üìä Status do Sistema</h2>
            <div class="status-grid">
                <div class="status-card" id="firebaseCard">
                    <h3>Firebase</h3>
                    <div class="value" id="firebaseValue">‚è≥</div>
                </div>
                <div class="status-card" id="usersCard">
                    <h3>Usu√°rios</h3>
                    <div class="value" id="usersValue">0</div>
                </div>
                <div class="status-card" id="pathCard">
                    <h3>Caminho</h3>
                    <div class="value" style="font-size: 14px;" id="pathValue">data/diversey_users</div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn-primary" onclick="diagnose()">
                    üîç Executar Diagn√≥stico
                </button>
                <button class="btn-secondary" onclick="clearLog()">
                    üóëÔ∏è Limpar Log
                </button>
            </div>
        </div>

        <div class="section" id="usersSection" style="display: none;">
            <h2>üë• Usu√°rios no Firebase</h2>
            <div class="users-table-wrapper">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Nome</th>
                            <th>Role</th>
                            <th>Email</th>
                            <th>Password Hash</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="section">
            <h2>üß™ Testar Autentica√ß√£o</h2>
            <div class="test-section">
                <div class="test-form">
                    <div class="form-group">
                        <label for="testUsername">Username:</label>
                        <input type="text" id="testUsername" placeholder="Digite o username">
                    </div>
                    <div class="form-group">
                        <label for="testPassword">Senha:</label>
                        <input type="password" id="testPassword" placeholder="Digite a senha">
                    </div>
                    <div class="form-group">
                        <label></label>
                        <button class="btn-primary" onclick="testAuth()" id="testAuthBtn" disabled>
                            üîê Testar Login
                        </button>
                    </div>
                </div>
                <div id="testResult" class="test-result"></div>
            </div>
        </div>

        <div class="log-section">
            <h2>üìä Log de Diagn√≥stico</h2>
            <div id="log"></div>
        </div>
    </div>

    <script type="module">
        // Import Firebase SDK v9 modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref, get, child } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

        let db = null;
        let app = null;
        let usersData = [];

        // Make functions available globally
        window.diagnose = diagnose;
        window.testAuth = testAuth;
        window.clearLog = clearLog;

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAkR0HSCj4rkT_NmvGLQEnDv2zNXiUaO7Q",
            authDomain: "solicitacoes-de-pecas.firebaseapp.com",
            databaseURL: "https://solicitacoes-de-pecas-default-rtdb.firebaseio.com",
            projectId: "solicitacoes-de-pecas",
            storageBucket: "solicitacoes-de-pecas.firebasestorage.app",
            messagingSenderId: "531360939",
            appId: "1:531360939:web:59f4e825a526463cc93d8f"
        };

        // SHA-256 hashing function - Canonical formula
        // Formula: SHA256(password + 'diversey_salt_v1:' + username)
        async function hashSHA256(password, username) {
            const salt = 'diversey_salt_v1';
            const input = password + salt + ':' + username;
            const encoder = new TextEncoder();
            const data = encoder.encode(input);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // Logging functions
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString('pt-BR');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('Log limpo', 'info');
        }

        function updateStatusCard(cardId, status, value) {
            const card = document.getElementById(cardId);
            const valueEl = document.getElementById(value + 'Value');
            
            card.classList.remove('connected', 'error');
            if (status === 'success') {
                card.classList.add('connected');
            } else if (status === 'error') {
                card.classList.add('error');
            }
            
            if (valueEl) {
                valueEl.textContent = value;
            }
        }

        function renderUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            if (usersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">Nenhum usu√°rio encontrado</td></tr>';
                return;
            }

            usersData.forEach(user => {
                const row = document.createElement('tr');
                
                const hasHash = user.passwordHash && user.passwordHash.length > 0;
                const isDisabled = user.disabled === true;
                
                row.innerHTML = `
                    <td><strong>${user.username || 'N/A'}</strong></td>
                    <td>${user.name || '-'}</td>
                    <td><span class="badge badge-info">${user.role || 'N/A'}</span></td>
                    <td>${user.email || '-'}</td>
                    <td><code title="${user.passwordHash || 'N/A'}">${user.passwordHash ? user.passwordHash.substring(0, 20) + '...' : 'N/A'}</code></td>
                    <td>
                        ${hasHash ? '<span class="badge badge-success">Hash OK</span>' : '<span class="badge badge-danger">Sem Hash</span>'}
                        ${isDisabled ? '<span class="badge badge-warning">Desabilitado</span>' : '<span class="badge badge-success">Ativo</span>'}
                    </td>
                `;
                
                tbody.appendChild(row);
            });

            document.getElementById('usersSection').style.display = 'block';
        }

        async function diagnose() {
            log('üöÄ Iniciando diagn√≥stico do sistema...', 'info');
            log('='.repeat(60), 'info');

            try {
                // 1. Initialize Firebase
                log('\nüì° 1. Conectando ao Firebase...', 'info');
                app = initializeApp(firebaseConfig);
                db = getDatabase(app);
                log('‚úÖ Firebase inicializado com sucesso', 'success');
                updateStatusCard('firebaseCard', 'success', '‚úÖ OK');

                // 2. Check database connection
                log('\nüîó 2. Verificando conex√£o com database...', 'info');
                log(`   URL: ${firebaseConfig.databaseURL}`, 'info');
                
                const dbRef = ref(db);
                const connectedRef = child(dbRef, '.info/connected');
                const connSnapshot = await get(connectedRef);
                const isConnected = connSnapshot.val() === true;
                
                if (isConnected) {
                    log('‚úÖ Conex√£o com database estabelecida', 'success');
                } else {
                    log('‚ö†Ô∏è Status de conex√£o indeterminado', 'warning');
                }

                // 3. Load users
                log('\nüë• 3. Carregando usu√°rios...', 'info');
                log('   Caminho: data/diversey_users', 'info');
                
                const snapshot = await get(child(dbRef, 'data/diversey_users'));
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    log('‚úÖ Dados encontrados', 'success');
                    
                    // Check data format
                    if (data && data.data && Array.isArray(data.data)) {
                        usersData = data.data;
                        log(`   Formato: Wrapper com propriedade 'data'`, 'info');
                    } else if (Array.isArray(data)) {
                        usersData = data;
                        log(`   Formato: Array direto`, 'info');
                    } else {
                        log(`‚ö†Ô∏è Formato inesperado:`, 'warning');
                        log(`   Tipo: ${typeof data}`, 'warning');
                        log(`   Keys: ${Object.keys(data).join(', ')}`, 'warning');
                        usersData = [];
                    }
                    
                    log(`‚úÖ ${usersData.length} usu√°rio(s) carregado(s)`, 'success');
                    updateStatusCard('usersCard', 'success', usersData.length);
                } else {
                    log('‚ö†Ô∏è Nenhum dado encontrado no caminho especificado', 'warning');
                    usersData = [];
                    updateStatusCard('usersCard', 'error', 0);
                }

                // 4. Analyze users
                if (usersData.length > 0) {
                    log('\nüîç 4. Analisando usu√°rios...', 'info');
                    
                    let withHash = 0;
                    let withoutHash = 0;
                    let disabled = 0;
                    let active = 0;
                    
                    usersData.forEach(user => {
                        log(`\n   üë§ ${user.username || 'unnamed'}`, 'info');
                        log(`      ID: ${user.id || 'N/A'}`, 'info');
                        log(`      Role: ${user.role || 'N/A'}`, 'info');
                        log(`      Email: ${user.email || 'N/A'}`, 'info');
                        log(`      Hash: ${user.passwordHash ? '‚úì Presente (' + user.passwordHash.length + ' chars)' : '‚úó Ausente'}`, user.passwordHash ? 'success' : 'error');
                        log(`      Status: ${user.disabled ? '‚úó Desabilitado' : '‚úì Ativo'}`, user.disabled ? 'warning' : 'success');
                        
                        if (user.passwordHash) withHash++;
                        else withoutHash++;
                        
                        if (user.disabled) disabled++;
                        else active++;
                    });
                    
                    log('\nüìä Resumo:', 'info');
                    log(`   Total: ${usersData.length}`, 'info');
                    log(`   Com hash: ${withHash}`, withHash > 0 ? 'success' : 'warning');
                    log(`   Sem hash: ${withoutHash}`, withoutHash > 0 ? 'error' : 'success');
                    log(`   Ativos: ${active}`, active > 0 ? 'success' : 'warning');
                    log(`   Desabilitados: ${disabled}`, disabled > 0 ? 'warning' : 'success');
                }

                // 5. Render table
                renderUsersTable();
                
                // Enable test auth button
                document.getElementById('testAuthBtn').disabled = false;

                log('\n' + '='.repeat(60), 'info');
                log('üéâ Diagn√≥stico conclu√≠do com sucesso!', 'success');

            } catch (error) {
                log(`\n‚ùå Erro durante diagn√≥stico: ${error.message}`, 'error');
                if (error.code) {
                    log(`   C√≥digo: ${error.code}`, 'error');
                }
                console.error('Erro completo:', error);
                updateStatusCard('firebaseCard', 'error', '‚ùå');
            }
        }

        async function testAuth() {
            const username = document.getElementById('testUsername').value.trim();
            const password = document.getElementById('testPassword').value;
            const resultDiv = document.getElementById('testResult');

            if (!username || !password) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = '‚ùå Por favor, preencha username e senha';
                return;
            }

            log(`\nüß™ Testando autentica√ß√£o para: ${username}`, 'info');

            try {
                // Find user
                const user = usersData.find(u => u.username === username);
                
                if (!user) {
                    log(`‚ùå Usu√°rio n√£o encontrado: ${username}`, 'error');
                    resultDiv.className = 'test-result error';
                    resultDiv.textContent = `‚ùå Usu√°rio "${username}" n√£o encontrado`;
                    return;
                }

                log(`‚úì Usu√°rio encontrado`, 'success');
                log(`   ID: ${user.id}`, 'info');
                log(`   Role: ${user.role}`, 'info');

                // Check if user has hash
                if (!user.passwordHash) {
                    log(`‚ùå Usu√°rio n√£o tem hash de senha`, 'error');
                    resultDiv.className = 'test-result error';
                    resultDiv.textContent = '‚ùå Usu√°rio n√£o tem hash de senha configurado';
                    return;
                }

                // Generate hash for input password
                const inputHash = await hashSHA256(password, username);
                log(`üîê Hash gerado para senha digitada:`, 'info');
                log(`   ${inputHash}`, 'info');
                log(`üîê Hash armazenado no usu√°rio:`, 'info');
                log(`   ${user.passwordHash}`, 'info');

                // Compare hashes
                if (inputHash === user.passwordHash) {
                    log(`‚úÖ Autentica√ß√£o bem-sucedida! Senha correta.`, 'success');
                    resultDiv.className = 'test-result success';
                    resultDiv.innerHTML = `
                        <strong>‚úÖ Autentica√ß√£o Bem-Sucedida!</strong><br>
                        Usu√°rio: ${user.username}<br>
                        Role: ${user.role}<br>
                        Senha est√° correta e hash corresponde.
                    `;
                } else {
                    log(`‚ùå Senha incorreta. Hashes n√£o correspondem.`, 'error');
                    resultDiv.className = 'test-result error';
                    resultDiv.innerHTML = `
                        <strong>‚ùå Senha Incorreta</strong><br>
                        Os hashes n√£o correspondem.<br>
                        Se voc√™ tem certeza que a senha est√° correta, pode ser necess√°rio resetar a senha do usu√°rio.
                    `;
                }

            } catch (error) {
                log(`‚ùå Erro ao testar autentica√ß√£o: ${error.message}`, 'error');
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `‚ùå Erro: ${error.message}`;
            }
        }

        // Initialize on load
        log('üîß Ferramenta de Diagn√≥stico carregada e pronta', 'info');
        log('‚ö†Ô∏è Clique em "Executar Diagn√≥stico" para come√ßar', 'warning');
    </script>
</body>
</html>
